# Plan de Implementación: Sistema de Fotografías para Compras a Particulares

## Resumen Ejecutivo

Implementar gestión de fotografías para las líneas de compra a particulares, con una descripción única por línea (compartida por todas las imágenes) y arquitectura preparada para futura integración con APIs de visión (OpenAI, Anthropic, Mistral).

## Estado Actual

### Estructura Existente

```python
# jewelry.client.purchase.line
image_ids = fields.Many2many('ir.attachment', ...)  # ✓ Ya existe
image_count = fields.Integer(compute=...)           # ✓ Ya existe
```

**Limitaciones actuales:**
1. No hay campo de descripción para las imágenes
2. No hay pestaña dedicada en el formulario principal
3. Sin preparación para integración con IA

---

## Diseño Propuesto (Simplificado)

### Enfoque

Mantener la estructura actual `Many2many → ir.attachment` y añadir campos de descripción directamente en la línea de compra.

**Ventajas:**
- Sin modelo nuevo que mantener
- Sin migración de datos necesaria
- Reutiliza infraestructura existente de Odoo (`ir.attachment`)
- Implementación rápida

### Modificación de `jewelry.client.purchase.line`

```python
class ClientPurchaseOrderLine(models.Model):
    _inherit = 'jewelry.client.purchase.line'

    # Descripción manual (compartida por todas las imágenes)
    image_description = fields.Text(
        string='Photo Description',
        help='Description of the items shown in the photos',
    )

    # === CAMPOS PARA FUTURA INTEGRACIÓN IA ===
    ai_description = fields.Text(
        string='AI Description',
        readonly=True,
        copy=False,
        help='Description generated by AI vision model',
    )
    ai_model = fields.Char(
        string='AI Model',
        readonly=True,
        copy=False,
        help='Model that generated the description (e.g., gpt-4-vision)',
    )
    ai_generated_date = fields.Datetime(
        string='AI Analysis Date',
        readonly=True,
        copy=False,
    )
    ai_confidence = fields.Float(
        string='AI Confidence',
        readonly=True,
        copy=False,
        digits=(3, 2),
        help='Confidence score from the AI model (0-1)',
    )
```

### Modificación de `jewelry.client.purchase`

Campo computado para total de fotos a nivel de orden:

```python
class ClientPurchaseOrder(models.Model):
    _inherit = 'jewelry.client.purchase'

    total_image_count = fields.Integer(
        string='Total Photos',
        compute='_compute_total_image_count',
    )

    @api.depends('line_ids.image_ids')
    def _compute_total_image_count(self):
        for order in self:
            order.total_image_count = sum(order.line_ids.mapped('image_count'))
```

---

## Diseño de Vistas

### 1. Nueva Pestaña "Photos" en Formulario Principal

Añadir después de la pestaña "Notes":

```xml
<page string="Photos" name="photos">
    <field name="line_ids" readonly="state != 'draft'">
        <list editable="bottom" create="false" delete="false">
            <field name="sequence" widget="handle"/>
            <field name="description" readonly="1"/>
            <field name="image_ids" widget="many2many_binary"
                   string="Photos"/>
            <field name="image_description"
                   placeholder="Describe the items..."/>
            <field name="image_count" string="Count"/>
        </list>
    </field>

    <!-- Información de IA (solo visible si hay datos) -->
    <group string="AI Analysis" invisible="not line_ids.ai_description">
        <p class="text-muted">
            <i class="fa fa-info-circle me-1"/>
            AI descriptions will appear here once generated.
        </p>
    </group>
</page>
```

### 2. Actualizar Lista de Líneas en Pestaña "Items"

Hacer clickeable la columna "Photos":

```xml
<field name="image_count" string="Photos"
       widget="statinfo"
       class="text-primary"/>
```

### 3. Actualizar Formulario Popup de Línea

Mejorar la sección de documentación:

```xml
<record id="jewelry_client_purchase_line_view_form" model="ir.ui.view">
    <field name="name">jewelry.client.purchase.line.view.form</field>
    <field name="model">jewelry.client.purchase.line</field>
    <field name="arch" type="xml">
        <form string="Purchase Line">
            <sheet>
                <group>
                    <group string="Item Details">
                        <field name="description"/>
                        <field name="quality_id"/>
                        <field name="weight"/>
                        <field name="price"/>
                        <field name="currency_id" invisible="1"/>
                    </group>
                    <group string="Photos">
                        <field name="image_ids" widget="many2many_binary"
                               nolabel="1" colspan="2"/>
                        <field name="image_description"
                               placeholder="Describe the items shown..."
                               colspan="2"/>
                    </group>
                </group>

                <!-- Sección IA (preparada para fase 2) -->
                <group string="AI Analysis"
                       invisible="not ai_description">
                    <field name="ai_description"/>
                    <field name="ai_model"/>
                    <field name="ai_generated_date"/>
                    <field name="ai_confidence" widget="progressbar"/>
                </group>

                <!-- Botón futuro para obtener descripción IA -->
                <!--
                <footer>
                    <button name="action_get_ai_description"
                            string="Get AI Description"
                            type="object"
                            class="btn-secondary"
                            icon="fa-magic"
                            invisible="not image_ids"/>
                </footer>
                -->
            </sheet>
        </form>
    </field>
</record>
```

---

## Estructura de Archivos

### Archivos a Modificar

```
custom-addons/jewelry_purchase_client/
├── models/
│   ├── client_purchase.py      # Añadir total_image_count
│   └── client_purchase_line.py # Añadir campos descripción + IA
├── views/
│   └── client_purchase_views.xml # Nueva pestaña + formulario línea
├── i18n/
│   └── es.po                    # Traducciones nuevos campos
└── __manifest__.py              # Incrementar versión
```

### No se requiere

- ~~Nuevo modelo~~ → Usamos campos en línea existente
- ~~Nuevos archivos de seguridad~~ → Modelo ya tiene ACLs
- ~~Migración de datos~~ → `image_ids` ya existe

---

## Preparación para Integración con IA (Fase 2)

### Método Placeholder

```python
def action_get_ai_description(self):
    """
    Placeholder para futura integración con IA.
    En fase 2, este método:
    1. Obtiene las imágenes de image_ids
    2. Las envía al proveedor de IA configurado
    3. Almacena la respuesta en ai_description
    """
    self.ensure_one()
    raise UserError(_(
        "AI integration is not yet configured. "
        "This feature will be available in a future update."
    ))
```

### Configuración del Sistema (Fase 2)

```python
# En res.config.settings
ai_vision_provider = fields.Selection([
    ('none', 'Disabled'),
    ('openai', 'OpenAI (GPT-4 Vision)'),
    ('anthropic', 'Anthropic (Claude)'),
    ('mistral', 'Mistral AI'),
], config_parameter='jewelry.ai_vision_provider')
```

---

## Diagrama de Relaciones

```
┌─────────────────────────────────┐
│  jewelry.client.purchase        │
│  ───────────────────────────    │
│  name, partner_id, date...      │
│  total_image_count (computed)   │
│                                 │
│  line_ids ──────────────────────┼──┐
└─────────────────────────────────┘  │
                                     │ One2many
                                     ▼
┌─────────────────────────────────┐
│  jewelry.client.purchase.line   │
│  ───────────────────────────    │
│  description, weight, price     │
│  image_ids ─────────────────────┼──→ ir.attachment (Many2many)
│  image_count (computed)         │
│  image_description ← NUEVO      │
│  ai_description    ← NUEVO      │
│  ai_model          ← NUEVO      │
│  ai_confidence     ← NUEVO      │
└─────────────────────────────────┘
```

---

## Plan de Implementación

### Fase 1: Campos y Vistas (Esta fase)

| Paso | Archivo | Cambio |
|------|---------|--------|
| 1 | `models/client_purchase_line.py` | Añadir `image_description`, campos `ai_*` |
| 2 | `models/client_purchase.py` | Añadir `total_image_count` |
| 3 | `views/client_purchase_views.xml` | Nueva pestaña "Photos", actualizar form línea |
| 4 | `i18n/es.po` | Traducciones |
| 5 | `__manifest__.py` | Incrementar versión a `18.0.1.2.0` |

**Complejidad:** Baja

### Fase 2: Integración con IA (Futura)

1. Crear módulo separado `jewelry_ai_vision`
2. Implementar proveedores para OpenAI, Anthropic, Mistral
3. Habilitar botón "Get AI Description"
4. Configuración en Settings

### Fase 3: Mejoras UX (Futura)

1. Widget OWL para galería con lightbox
2. Drag-and-drop para reordenar imágenes

---

## Traducciones (es.po)

```po
#. module: jewelry_purchase_client
#: model:ir.model.fields,field_description:jewelry_purchase_client.field_jewelry_client_purchase_line__image_description
msgid "Photo Description"
msgstr "Descripción de Fotos"

#. module: jewelry_purchase_client
#: model:ir.model.fields,field_description:jewelry_purchase_client.field_jewelry_client_purchase_line__ai_description
msgid "AI Description"
msgstr "Descripción IA"

#. module: jewelry_purchase_client
#: model:ir.model.fields,field_description:jewelry_purchase_client.field_jewelry_client_purchase__total_image_count
msgid "Total Photos"
msgstr "Total de Fotos"
```

---

## Checklist de Implementación

- [x] Añadir campo `image_description` a línea
- [x] Añadir campos `ai_*` a línea (preparación)
- [x] Añadir `total_image_count` a orden
- [x] Crear pestaña "Photos" en formulario orden
- [x] Actualizar formulario popup de línea
- [x] Actualizar traducciones
- [x] Incrementar versión del módulo (18.0.1.2.0)
- [ ] Probar subida de imágenes
- [ ] Probar descripción se guarda correctamente

## Historial de Cambios

### v18.0.1.2.0 (2025-12-07)

**Archivos modificados:**

1. `models/client_purchase_line.py`
   - Añadido `image_description` (Text)
   - Añadidos campos IA: `ai_description`, `ai_model`, `ai_generated_date`, `ai_confidence`

2. `models/client_purchase.py`
   - Añadido `total_image_count` (computed)
   - Añadido método `_compute_total_image_count()`

3. `views/client_purchase_views.xml`
   - Nueva pestaña "Photos" con lista editable de líneas
   - Mensaje informativo cuando no hay fotos
   - Formulario de línea actualizado con sección "Photos" y "AI Analysis"

4. `i18n/es.po`
   - Traducciones para todos los campos nuevos

5. `__manifest__.py`
   - Versión actualizada a 18.0.1.2.0

---

## Referencias

- [CLAUDE.md - Reglas del proyecto](../../CLAUDE.md)
- Modelo existente: `custom-addons/jewelry_purchase_client/models/client_purchase_line.py`
